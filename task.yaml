# Location Question Implementation - Task Plan
# Version: 1.5.0
# Created: 2025-11-26
# Updated: 2025-11-27 (Aligned with ARCH-003 AnswerValue hierarchy)
# Total Estimated Effort: 28-42 hours
# Calendar Time: 3-5 days (1 developer)

metadata:
  feature: "Location Question Type"
  version: "1.5.0"
  complexity: "Medium"
  risk: "Low"
  status: "Ready for Implementation"
  total_tasks: 29
  estimated_hours_min: 35.5
  estimated_hours_max: 54.5
  architecture_notes: |
    IMPORTANT: This task plan has been updated to align with completed
    architectural improvements (ARCH-001, ARCH-002, ARCH-003).

    Key changes from original plan:
    1. CORE-001: QuestionType.cs is in Entities/, not Enums/
    2. CORE-002: Now creates LocationAnswerValue (value object) instead of LocationAnswerDto
    3. All layers use LocationAnswerValue for validation and serialization
    4. Factory methods and private setters already implemented in all entities

    Prerequisites completed:
    - ‚úÖ ARCH-001: Private setters for all entities
    - ‚úÖ ARCH-002: Factory methods for all entities
    - ‚úÖ ARCH-003: AnswerValue polymorphic hierarchy (TextAnswerValue, SingleChoiceAnswerValue, etc.)

# ==============================================================================
# PHASE 0: DATABASE MIGRATION (BLOCKER)
# ==============================================================================

- task_id: DATABASE-001
  title: "Update QuestionType CHECK constraint to allow Location = 4"
  layer: "Infrastructure"
  assigned_to: "ef-core-agent"
  priority: "CRITICAL"
  estimated_hours: 0.5
  dependencies: []
  parallel_safe: false
  status: "pending"
  blocker: true
  description: |
    Create and apply migration to update the CHECK constraint in questions table
    to allow QuestionType value 4 (Location).

    CRITICAL: This is a BLOCKER task. Without this migration, any attempt to
    create Location questions will fail with a CHECK constraint violation.

    Current constraint only allows 0-3:
    "chk_question_type" CHECK (question_type IN (0, 1, 2, 3))

    Must update to:
    "chk_question_type" CHECK (question_type IN (0, 1, 2, 3, 4))

  files:
    - path: "src/SurveyBot.Infrastructure/Data/Configurations/QuestionConfiguration.cs"
      action: "reference"
      note: "Current constraint at lines 47-49"
    - path: "src/SurveyBot.Infrastructure/Migrations/[NEW]_AddLocationQuestionType.cs"
      action: "create"
      note: "New migration file"

  acceptance_criteria:
    - "Migration created with name AddLocationQuestionType"
    - "Up() method drops old constraint and adds new constraint with value 4"
    - "Down() method reverts to original constraint (0-3)"
    - "Migration applied successfully to development database"
    - "Existing data unaffected by migration"
    - "Can insert question with question_type = 4 without errors"

  technical_notes: |
    Migration SQL:

    Up():
    ALTER TABLE questions DROP CONSTRAINT IF EXISTS chk_question_type;
    ALTER TABLE questions ADD CONSTRAINT chk_question_type
      CHECK (question_type IN (0, 1, 2, 3, 4));

    Down():
    ALTER TABLE questions DROP CONSTRAINT IF EXISTS chk_question_type;
    ALTER TABLE questions ADD CONSTRAINT chk_question_type
      CHECK (question_type IN (0, 1, 2, 3));

    Commands:
    cd src/SurveyBot.API
    dotnet ef migrations add AddLocationQuestionType
    dotnet ef database update

# ==============================================================================
# PHASE 1: CORE LAYER (ZERO DEPENDENCIES)
# ==============================================================================

- task_id: CORE-001
  title: "Add Location to QuestionType enum"
  layer: "Core"
  assigned_to: "ef-core-agent"
  priority: "High"
  estimated_hours: 0.5
  dependencies: ["DATABASE-001"]
  parallel_safe: false
  status: "pending"
  description: |
    Add Location = 4 to QuestionType enum in Core layer.
    This is the foundation for all other Location question functionality.

  files:
    - path: "src/SurveyBot.Core/Entities/QuestionType.cs"
      action: "modify"
      note: "Add Location = 4 enum value (NOTE: QuestionType is in Entities/, not Enums/)"

  acceptance_criteria:
    - "Location enum value added with value 4"
    - "XML documentation comment added describing Location type"
    - "Project compiles without errors"
    - "No breaking changes to existing enum values"

  technical_notes: |
    Add to QuestionType.cs:

    public enum QuestionType
    {
        Text = 0,
        SingleChoice = 1,
        MultipleChoice = 2,
        Rating = 3,

        /// <summary>
        /// Geographic location question requesting latitude/longitude coordinates.
        /// Displayed via Telegram's location sharing functionality.
        /// </summary>
        Location = 4
    }

- task_id: CORE-002
  title: "Create LocationAnswerValue value object"
  layer: "Core"
  assigned_to: "ef-core-agent"
  priority: "High"
  estimated_hours: 2.5
  dependencies: ["CORE-001"]
  parallel_safe: false
  status: "pending"
  description: |
    Create LocationAnswerValue as part of existing AnswerValue polymorphic hierarchy.

    IMPORTANT: The project already has AnswerValue value object hierarchy implemented
    (ARCH-003 completed). LocationAnswerValue must integrate with:
    - AnswerValue base class (add JsonDerivedType attribute)
    - AnswerValueFactory (add Location case to Parse/CreateFromInput)

    This follows the established DDD pattern for answer values.

  files:
    - path: "src/SurveyBot.Core/ValueObjects/Answers/LocationAnswerValue.cs"
      action: "create"
      note: "New value object following existing pattern (see TextAnswerValue.cs)"
    - path: "src/SurveyBot.Core/ValueObjects/Answers/AnswerValue.cs"
      action: "modify"
      note: "Add [JsonDerivedType(typeof(LocationAnswerValue), typeDiscriminator: 'Location')]"
    - path: "src/SurveyBot.Core/ValueObjects/Answers/AnswerValueFactory.cs"
      action: "modify"
      note: "Add QuestionType.Location case to Parse() and CreateFromInput()"

  acceptance_criteria:
    - "LocationAnswerValue inherits from AnswerValue"
    - "Properties: Latitude (double), Longitude (double), Accuracy (double?), Timestamp (DateTime?)"
    - "Implements abstract members: QuestionType, DisplayValue, ToJson(), IsValidFor()"
    - "Factory method: Create(latitude, longitude, accuracy?, timestamp?) with validation"
    - "Factory method: FromJson(string json) for deserialization"
    - "Validation: lat -90 to 90, lon -180 to 180"
    - "DisplayValue returns formatted coordinates: '40.712776, -74.005974'"
    - "Value semantics: Equals(), GetHashCode() implemented"
    - "JsonDerivedType added to AnswerValue.cs with discriminator 'Location'"
    - "AnswerValueFactory.Parse() handles QuestionType.Location"
    - "AnswerValueFactory.CreateFromInput() handles Location type"
    - "XML documentation comments for all public members"

  technical_notes: |
    Follow existing pattern from TextAnswerValue.cs and RatingAnswerValue.cs:

    // LocationAnswerValue.cs
    public sealed class LocationAnswerValue : AnswerValue
    {
        [JsonPropertyName("latitude")]
        public double Latitude { get; private set; }

        [JsonPropertyName("longitude")]
        public double Longitude { get; private set; }

        [JsonPropertyName("accuracy")]
        public double? Accuracy { get; private set; }

        [JsonPropertyName("timestamp")]
        public DateTime? Timestamp { get; private set; }

        [JsonIgnore]
        public override QuestionType QuestionType => QuestionType.Location;

        [JsonIgnore]
        public override string DisplayValue =>
            $"{Latitude:F6}, {Longitude:F6}";

        private LocationAnswerValue(double lat, double lon, double? acc, DateTime? ts)
        {
            Latitude = lat;
            Longitude = lon;
            Accuracy = acc;
            Timestamp = ts;
        }

        [JsonConstructor]
        private LocationAnswerValue() { }

        public static LocationAnswerValue Create(
            double latitude,
            double longitude,
            double? accuracy = null,
            DateTime? timestamp = null)
        {
            if (latitude < -90.0 || latitude > 90.0)
                throw new InvalidAnswerFormatException(0, QuestionType.Location,
                    $"Latitude must be between -90 and 90, got {latitude}");

            if (longitude < -180.0 || longitude > 180.0)
                throw new InvalidAnswerFormatException(0, QuestionType.Location,
                    $"Longitude must be between -180 and 180, got {longitude}");

            if (accuracy.HasValue && accuracy.Value < 0)
                throw new InvalidAnswerFormatException(0, QuestionType.Location,
                    "Accuracy cannot be negative");

            return new LocationAnswerValue(latitude, longitude, accuracy, timestamp);
        }

        public static LocationAnswerValue FromJson(string json) { ... }

        public override string ToJson() =>
            JsonSerializer.Serialize(new LocationData { ... });

        public override bool IsValidFor(Question question) =>
            question.QuestionType == QuestionType.Location;

        public override bool Equals(AnswerValue? other) =>
            other is LocationAnswerValue loc &&
            Latitude == loc.Latitude &&
            Longitude == loc.Longitude;

        public override int GetHashCode() =>
            HashCode.Combine(QuestionType, Latitude, Longitude);
    }

    // Add to AnswerValue.cs (line ~14):
    [JsonDerivedType(typeof(LocationAnswerValue), typeDiscriminator: "Location")]

    // Add to AnswerValueFactory.Parse() switch:
    QuestionType.Location => LocationAnswerValue.FromJson(json),

    // Add to AnswerValueFactory.CreateFromInput():
    QuestionType.Location => CreateLocationAnswer(latitude, longitude, accuracy, timestamp),

- task_id: CORE-003
  title: "Update AnswerDto to support LocationAnswerValue"
  layer: "Core"
  assigned_to: "ef-core-agent"
  priority: "High"
  estimated_hours: 1.0
  dependencies: ["CORE-002"]
  parallel_safe: false
  status: "pending"
  description: |
    Update AnswerDto to work with LocationAnswerValue from the value object hierarchy.

    NOTE: Since AnswerValue hierarchy is already implemented, we leverage it
    for Location data. The DTO should expose location-specific properties
    extracted from the value object.

  files:
    - path: "src/SurveyBot.Core/DTOs/Answer/AnswerDto.cs"
      action: "modify"
      note: "Add location properties and update display logic"

  acceptance_criteria:
    - "Latitude, Longitude, Accuracy, Timestamp properties added (nullable doubles/DateTime)"
    - "GetDisplayValue() or existing display logic handles QuestionType.Location"
    - "Location display format shows: '40.712776, -74.005974'"
    - "Backward compatible with existing question types"
    - "XML documentation added for location properties"
    - "AutoMapper can map from LocationAnswerValue to these DTO properties"

  technical_notes: |
    Option 1 - Flat properties (recommended for API simplicity):
    /// <summary>
    /// Latitude for Location question types. Null for other types.
    /// </summary>
    public double? Latitude { get; set; }

    /// <summary>
    /// Longitude for Location question types. Null for other types.
    /// </summary>
    public double? Longitude { get; set; }

    /// <summary>
    /// Accuracy in meters for Location question types. Null if not provided.
    /// </summary>
    public double? LocationAccuracy { get; set; }

    /// <summary>
    /// Timestamp when location was captured. Null if not provided.
    /// </summary>
    public DateTime? LocationTimestamp { get; set; }

    Option 2 - Nested object:
    public LocationDataDto? LocationData { get; set; }

    // Where LocationDataDto is a simple DTO:
    public class LocationDataDto
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public double? Accuracy { get; set; }
        public DateTime? Timestamp { get; set; }
        public string FormattedCoordinates => $"{Latitude:F6}, {Longitude:F6}";
    }

    The AutoMapper profile (API layer) will extract values from LocationAnswerValue.

- task_id: CORE-004
  title: "Add InvalidLocationException"
  layer: "Core"
  assigned_to: "ef-core-agent"
  priority: "High"
  estimated_hours: 0.5
  dependencies: []
  parallel_safe: true
  status: "pending"
  description: |
    Create custom domain exception for invalid location data.
    Used across layers for coordinate validation failures.

  files:
    - path: "src/SurveyBot.Core/Exceptions/InvalidLocationException.cs"
      action: "create"
      note: "New domain exception"

  acceptance_criteria:
    - "Inherits from Exception"
    - "Includes Latitude and Longitude properties"
    - "Provides constructors for message-only and message-with-coordinates"
    - "Follows existing exception patterns in Core layer"
    - "XML documentation added"

  technical_notes: |
    Constructor overloads:
    1. InvalidLocationException(string message)
    2. InvalidLocationException(string message, double latitude, double longitude)

    Properties expose coordinates for debugging/logging purposes.

# ==============================================================================
# PHASE 2: BOT LAYER (TELEGRAM INTEGRATION)
# ==============================================================================

- task_id: BOT-001
  title: "Create LocationQuestionHandler"
  layer: "Bot"
  assigned_to: "telegram-bot-handler-agent"
  priority: "Critical"
  estimated_hours: 5
  dependencies: ["CORE-001", "CORE-002", "CORE-004"]
  parallel_safe: false
  status: "pending"
  description: |
    Implement LocationQuestionHandler to display location request button and
    process location responses from Telegram.

    CRITICAL REQUIREMENTS:
    1. MUST use ReplyKeyboardMarkup (NOT InlineKeyboardMarkup)
    2. KeyboardButton.WithRequestLocation() only works with ReplyKeyboardMarkup
    3. MUST serialize location to JSON for AnswerJson parameter
    4. MUST remove keyboard with ReplyKeyboardRemove after submission
    5. MUST validate coordinates before saving
    6. MUST support /skip for optional questions

  files:
    - path: "src/SurveyBot.Bot/Handlers/Questions/LocationQuestionHandler.cs"
      action: "create"
      note: "New handler implementing IQuestionHandler"

  acceptance_criteria:
    - "Implements IQuestionHandler interface"
    - "CanHandle() returns true for QuestionType.Location"
    - "CRITICAL: Uses ReplyKeyboardMarkup (NOT InlineKeyboardMarkup)"
    - "Displays Share Location button via KeyboardButton.WithRequestLocation()"
    - "Validates coordinates: lat -90 to 90, lon -180 to 180"
    - "CRITICAL: Serializes location to JSON for AnswerJson parameter"
    - "Saves location data to Answer.AnswerJson via ResponseService"
    - "Supports /skip command for optional questions"
    - "Rejects /skip for required questions with error message"
    - "Handles text input with error message (expects location, not text)"
    - "CRITICAL: Removes keyboard with ReplyKeyboardRemove after submission"
    - "ILogger<LocationQuestionHandler> injected for logging"
    - "Logs: button display, location received, validation, save, skip events"
    - "Logs: Uses GetCoordinateRange() for privacy-preserving coordinate logging"

  technical_notes: |
    CRITICAL: ReplyKeyboardMarkup is REQUIRED for location requests!

    CreateLocationKeyboard() method:
    private ReplyKeyboardMarkup CreateLocationKeyboard(bool isRequired)
    {
        var buttons = new List<KeyboardButton[]>
        {
            new[] { KeyboardButton.WithRequestLocation("üìç Share Location") }
        };

        if (!isRequired)
        {
            buttons.Add(new[] { new KeyboardButton("/skip") });
        }

        return new ReplyKeyboardMarkup(buttons)
        {
            ResizeKeyboard = true,
            OneTimeKeyboard = true
        };
    }

    Process location using LocationAnswerValue:
    if (message.Location != null)
    {
        var latitude = message.Location.Latitude;
        var longitude = message.Location.Longitude;
        var accuracy = message.Location.HorizontalAccuracy;

        // Create value object (validation happens in factory method)
        var locationValue = LocationAnswerValue.Create(
            latitude,
            longitude,
            accuracy,
            DateTime.UtcNow);

        // Serialize to JSON for SaveAnswerAsync
        var locationJson = locationValue.ToJson();

        // Save using answerJson parameter
        await _responseService.SaveAnswerAsync(
            responseId,
            questionId,
            answerJson: locationJson);

        // CRITICAL: Remove keyboard after submission
        await _botClient.SendMessage(
            chatId: chatId,
            text: "üìç Location received! Thank you.",
            replyMarkup: new ReplyKeyboardRemove());
    }

    Logging:
    - Use GetCoordinateRange() helper to log coordinate ranges, not exact values
    - Log at: display, receive, validate, save, skip, error stages

    GetCoordinateRange() helper:
    private static string GetCoordinateRange(double coordinate)
    {
        var rounded = Math.Floor(coordinate / 10) * 10;
        return $"{rounded} to {rounded + 10}";
    }

- task_id: BOT-002
  title: "Update UpdateHandler to route Location messages"
  layer: "Bot"
  assigned_to: "telegram-bot-handler-agent"
  priority: "Critical"
  estimated_hours: 2.5
  dependencies: ["BOT-001"]
  parallel_safe: false
  status: "pending"
  description: |
    Fix UpdateHandler message routing to detect and route Location messages.

    CRITICAL BUG: Current code at line 107-111 returns false for ANY message
    without text, which means Location messages are SILENTLY DROPPED!

    Must restructure HandleMessageAsync to check for Location BEFORE text null check.

  files:
    - path: "src/SurveyBot.Bot/Services/UpdateHandler.cs"
      action: "modify"
      note: "Add Location message routing BEFORE text null check"

  acceptance_criteria:
    - "CRITICAL: Location check happens BEFORE text null check"
    - "HandleLocationMessageAsync() method added"
    - "Routes Location messages to LocationQuestionHandler via IQuestionHandler"
    - "Handles missing conversation state gracefully with error message"
    - "Returns appropriate boolean for handled/unhandled messages"
    - "Logging: Logs location message detection and routing"
    - "Logging: Logs warnings for missing conversation state"

  technical_notes: |
    CRITICAL FIX: Restructure HandleMessageAsync

    Current code (BROKEN - line 107-111):
    private async Task<bool> HandleMessageAsync(Message message, CancellationToken ct)
    {
        if (message.Text == null)
        {
            _logger.LogDebug("Message has no text content, ignoring");
            return false;  // ‚ùå Location messages get ignored here!
        }
        // ... rest of text handling
    }

    Required fix:
    private async Task<bool> HandleMessageAsync(Message message, CancellationToken ct)
    {
        // CRITICAL: Check Location FIRST, before text null check
        if (message.Location != null)
        {
            _logger.LogDebug("Processing location message from {UserId}",
                message.From?.Id);
            return await HandleLocationMessageAsync(message, ct);
        }

        if (message.Text != null)
        {
            return await HandleTextMessageAsync(message, ct);
        }

        // Only now ignore truly unhandled message types
        _logger.LogDebug("Message has no text or location content, ignoring");
        return false;
    }

    New method to add:
    private async Task<bool> HandleLocationMessageAsync(
        Message message,
        CancellationToken ct)
    {
        var userId = message.From?.Id;
        if (userId == null) return false;

        // Get conversation state
        var state = await _stateService.GetStateAsync(userId.Value);
        if (state?.CurrentSurveyId == null || state?.CurrentQuestionId == null)
        {
            await _botClient.SendMessage(
                message.Chat.Id,
                "‚ö†Ô∏è No active survey. Use /surveys to start one.",
                cancellationToken: ct);
            return false;
        }

        // Delegate to LocationQuestionHandler
        var handler = _questionHandlers.FirstOrDefault(
            h => h.CanHandle(QuestionType.Location));
        if (handler != null)
        {
            return await handler.HandleAsync(message, state, ct);
        }

        return false;
    }

- task_id: BOT-003
  title: "Register LocationQuestionHandler in DI container"
  layer: "Bot"
  assigned_to: "telegram-bot-handler-agent"
  priority: "High"
  estimated_hours: 0.5
  dependencies: ["BOT-001"]
  parallel_safe: false
  status: "pending"
  description: |
    Add LocationQuestionHandler to dependency injection configuration.

  files:
    - path: "src/SurveyBot.Bot/Extensions/BotServiceExtensions.cs"
      action: "modify"
      note: "Register LocationQuestionHandler as IQuestionHandler"

  acceptance_criteria:
    - "Handler registered in DI container as scoped service"
    - "Application starts without DI errors"
    - "Handler can be resolved via IEnumerable<IQuestionHandler>"

  technical_notes: |
    Add to BotServiceExtensions.cs:

    services.AddScoped<IQuestionHandler, LocationQuestionHandler>();

    Verify registration order doesn't matter (handlers resolved via IEnumerable).

- task_id: BOT-004
  title: "Update HelpCommandHandler for Location questions"
  layer: "Bot"
  assigned_to: "telegram-bot-handler-agent"
  priority: "Medium"
  estimated_hours: 1
  dependencies: ["BOT-001"]
  parallel_safe: true
  status: "pending"
  description: |
    Update help command to include Location question type information
    and usage instructions for location sharing.

  files:
    - path: "src/SurveyBot.Bot/Handlers/HelpCommandHandler.cs"
      action: "modify"
      note: "Add Location to question types list and usage guidance"

  acceptance_criteria:
    - "Location mentioned in question types list"
    - "Mobile usage instructions provided (tap Share Location button)"
    - "Desktop usage instructions provided (manual map selection)"
    - "/skip command mentioned for optional Location questions"

  technical_notes: |
    Add to question types section:

    üìç **Location** - Request geographic coordinates
       ‚Ä¢ Mobile: Tap "Share Location" to share current location
       ‚Ä¢ Desktop: Click button to select location on map
       ‚Ä¢ Optional questions: Send /skip to skip

- task_id: BOT-005
  title: "Update Bot layer CLAUDE.md documentation"
  layer: "Bot"
  assigned_to: "telegram-bot-handler-agent"
  priority: "Medium"
  estimated_hours: 2.5
  dependencies: ["BOT-001", "BOT-002", "BOT-003", "BOT-004"]
  parallel_safe: false
  status: "pending"
  description: |
    Update Bot layer documentation to reflect Location question functionality.

  files:
    - path: "src/SurveyBot.Bot/CLAUDE.md"
      action: "modify"
      note: "Document Location question handling"

  acceptance_criteria:
    - "LocationQuestionHandler documented in Handlers section"
    - "Location message routing documented in UpdateHandler section"
    - "ReplyKeyboardMarkup usage documented with code examples"
    - "Location answer storage format documented (JSON structure)"
    - "Version updated to 1.5.0"
    - "Recent changes section updated"

  technical_notes: |
    Document:
    1. LocationQuestionHandler implementation details
    2. ReplyKeyboardMarkup requirement (not InlineKeyboardMarkup)
    3. Location message routing in UpdateHandler
    4. JSON serialization format
    5. Privacy-preserving logging approach

# ==============================================================================
# PHASE 3: INFRASTRUCTURE LAYER (VALIDATION & SERVICES)
# ==============================================================================

- task_id: INFRA-001
  title: "Add Location validation to ResponseService"
  layer: "Infrastructure"
  assigned_to: "ef-core-agent"
  priority: "Critical"
  estimated_hours: 2.5
  dependencies: ["CORE-002", "CORE-004"]
  parallel_safe: false
  status: "pending"
  description: |
    Add Location question validation to ResponseService.

    CRITICAL BUGS TO FIX:
    1. ValidateAnswerFormatAsync (line 357-378) has NO case for QuestionType.Location
    2. CreateAnswerJson (line 638-658) returns NULL for Location type

    Without these fixes, Location answers will bypass validation and data will be lost!

  files:
    - path: "src/SurveyBot.Infrastructure/Services/ResponseService.cs"
      action: "modify"
      note: "Add Location case to ValidateAnswerFormatAsync and CreateAnswerJson"

  acceptance_criteria:
    - "CRITICAL: case QuestionType.Location added to ValidateAnswerFormatAsync"
    - "ValidateLocationData() helper method added"
    - "Validates coordinate bounds: lat -90 to 90, lon -180 to 180"
    - "Throws InvalidLocationException for invalid coordinates"
    - "Throws ValidationException for missing/invalid JSON"
    - "CRITICAL: case QuestionType.Location added to CreateAnswerJson (returns answerJson)"
    - "SaveAnswerAsync properly handles answerJson parameter for Location"
    - "ILogger<ResponseService> already injected (verify)"
    - "Logging: Logs validation start, success, failure with coordinate ranges"
    - "Logging: Logs JSON deserialization errors"
    - "Logging: Logs save operations for Location answers"
    - "Logging: Uses GetCoordinateRange() helper method"

  technical_notes: |
    CRITICAL FIX 1: Add Location case to ValidateAnswerFormatAsync (around line 357)

    private async Task ValidateAnswerFormatAsync(
        Question question,
        string? answerText,
        List<string>? selectedOptions,
        int? ratingValue,
        string? answerJson)
    {
        switch (question.QuestionType)
        {
            case QuestionType.Text:
                // existing validation...
                break;
            case QuestionType.SingleChoice:
                // existing validation...
                break;
            case QuestionType.MultipleChoice:
                // existing validation...
                break;
            case QuestionType.Rating:
                // existing validation...
                break;

            // CRITICAL: Add this case!
            case QuestionType.Location:
                if (string.IsNullOrWhiteSpace(answerJson))
                    throw new ValidationException(
                        "Location answer requires coordinate data.");
                ValidateLocationData(answerJson);
                break;
        }
    }

    CRITICAL FIX 2: Add ValidateLocationData helper method using LocationAnswerValue

    private void ValidateLocationData(string answerJson)
    {
        try
        {
            // Use LocationAnswerValue.FromJson() which includes validation
            var locationValue = LocationAnswerValue.FromJson(answerJson);

            _logger.LogInformation(
                "Location coordinates validated: Lat range {LatRange}, Lon range {LonRange}",
                GetCoordinateRange(locationValue.Latitude),
                GetCoordinateRange(locationValue.Longitude));
        }
        catch (InvalidAnswerFormatException ex)
        {
            _logger.LogError(ex, "Invalid location data: {Json}", answerJson);
            throw;  // Re-throw domain exception
        }
        catch (JsonException ex)
        {
            _logger.LogError(ex, "Invalid JSON format for location answer: {Json}",
                answerJson);
            throw new ValidationException("Invalid JSON format for location answer.", ex);
        }
    }

    Alternative: Use AnswerValueFactory for consistent parsing:
    private void ValidateLocationData(string answerJson)
    {
        // AnswerValueFactory.Parse handles all validation
        var answerValue = AnswerValueFactory.Parse(answerJson, QuestionType.Location);
        // If we get here, validation passed
    }

    CRITICAL FIX 3: Update CreateAnswerJson helper (around line 638)

    private string? CreateAnswerJson(
        Question question,
        string? answerText,
        List<string>? selectedOptions,
        int? ratingValue,
        string? answerJson)
    {
        switch (question.QuestionType)
        {
            case QuestionType.SingleChoice:
            case QuestionType.MultipleChoice:
                // existing JSON creation...

            case QuestionType.Rating:
                // existing JSON creation...

            // CRITICAL: Add this case - pass through already-formatted JSON
            case QuestionType.Location:
                return answerJson;  // Already serialized by handler

            default:
                return null;
        }
    }

    Add GetCoordinateRange() helper:
    private static string GetCoordinateRange(double coordinate)
    {
        var rounded = Math.Floor(coordinate / 10) * 10;
        return $"{rounded} to {rounded + 10}";
    }

- task_id: INFRA-002
  title: "Add Location validation to QuestionService"
  layer: "Infrastructure"
  assigned_to: "ef-core-agent"
  priority: "High"
  estimated_hours: 1.5
  dependencies: ["CORE-001"]
  parallel_safe: false
  status: "pending"
  description: |
    Add validation rules to QuestionService for Location question creation.
    Location questions have specific constraints.

  files:
    - path: "src/SurveyBot.Infrastructure/Services/QuestionService.cs"
      action: "modify"
      note: "Add Location-specific validation rules"

  acceptance_criteria:
    - "Validates Location questions cannot have Options collection"
    - "Validates Location questions cannot have conditional flow (DefaultNextQuestionId must be null)"
    - "Throws ValidationException with clear error messages"
    - "Validation runs in CreateQuestionAsync and UpdateQuestionAsync"

  technical_notes: |
    Validation rules for Location questions:

    1. No options allowed:
       if (questionType == QuestionType.Location && options?.Any() == true)
           throw new ValidationException(
               "Location questions cannot have options.");

    2. No conditional flow:
       if (questionType == QuestionType.Location && defaultNextQuestionId.HasValue)
           throw new ValidationException(
               "Location questions do not support conditional flow.");

    Rationale: Location questions produce continuous data (coordinates),
    not discrete choices suitable for conditional branching.

- task_id: INFRA-003
  title: "Update Infrastructure layer CLAUDE.md documentation"
  layer: "Infrastructure"
  assigned_to: "ef-core-agent"
  priority: "Medium"
  estimated_hours: 1
  dependencies: ["INFRA-001", "INFRA-002"]
  parallel_safe: false
  status: "pending"
  description: |
    Update Infrastructure layer documentation for Location question support.

  files:
    - path: "src/SurveyBot.Infrastructure/CLAUDE.md"
      action: "modify"
      note: "Document Location validation and storage"

  acceptance_criteria:
    - "Location validation documented in ResponseService section"
    - "Location constraints documented in QuestionService section"
    - "JSON storage format documented"
    - "Version updated to 1.5.0"

  technical_notes: |
    Document:
    1. ValidateLocationData() method in ResponseService
    2. Location question constraints in QuestionService
    3. JSON storage format in Answer.AnswerJson
    4. Coordinate validation bounds

# ==============================================================================
# PHASE 4: API LAYER (REST ENDPOINTS & MAPPING)
# ==============================================================================

- task_id: API-001
  title: "Update AutoMapper profile for LocationAnswerValue"
  layer: "API"
  assigned_to: "aspnet-api-agent"
  priority: "Critical"
  estimated_hours: 2.5
  dependencies: ["CORE-002", "CORE-003"]
  parallel_safe: false
  status: "pending"
  description: |
    Update AutoMapper AnswerMappingProfile to map Location data from LocationAnswerValue.

    Since AnswerValue hierarchy is implemented, the resolver should use
    LocationAnswerValue.FromJson() or AnswerValueFactory for parsing.

    CRITICAL: Current mapping does NOT include Location data.
    Without this fix, API responses will NOT include location data!

  files:
    - path: "src/SurveyBot.API/Mapping/AnswerMappingProfile.cs"
      action: "modify"
      note: "Add Location data mapping with custom resolver using LocationAnswerValue"

  acceptance_criteria:
    - "CRITICAL: AnswerLocationResolver class created using LocationAnswerValue"
    - "CRITICAL: Location properties (Latitude, Longitude, etc.) mapped to AnswerDto"
    - "Resolver uses LocationAnswerValue.FromJson() or AnswerValueFactory.TryParse()"
    - "Graceful handling of invalid/missing JSON (returns null values)"
    - "AnswerDto location properties populated in API responses"
    - "Logging: Logs parse attempts, success, and failures"

  technical_notes: |
    CRITICAL FIX: Add Location data mapping using value object

    Update CreateMap in AnswerMappingProfile.cs:

    CreateMap<Answer, AnswerDto>()
        .ForMember(dest => dest.SelectedOptions,
            opt => opt.MapFrom<AnswerSelectedOptionsResolver>())
        .ForMember(dest => dest.RatingValue,
            opt => opt.MapFrom<AnswerRatingValueResolver>())
        // Add location mappings
        .ForMember(dest => dest.Latitude,
            opt => opt.MapFrom<AnswerLocationLatitudeResolver>())
        .ForMember(dest => dest.Longitude,
            opt => opt.MapFrom<AnswerLocationLongitudeResolver>())
        .ForMember(dest => dest.LocationAccuracy,
            opt => opt.MapFrom<AnswerLocationAccuracyResolver>())
        .ForMember(dest => dest.LocationTimestamp,
            opt => opt.MapFrom<AnswerLocationTimestampResolver>());

    OR use single resolver with nested DTO:
        .ForMember(dest => dest.LocationData,
            opt => opt.MapFrom<AnswerLocationDataResolver>());

    Create resolver using LocationAnswerValue:

    /// <summary>
    /// Resolves Location data from Answer.AnswerJson using LocationAnswerValue.
    /// </summary>
    public class AnswerLocationDataResolver :
        IValueResolver<Answer, AnswerDto, LocationDataDto?>
    {
        private readonly ILogger<AnswerLocationDataResolver>? _logger;

        public AnswerLocationDataResolver(
            ILogger<AnswerLocationDataResolver>? logger = null)
        {
            _logger = logger;
        }

        public LocationDataDto? Resolve(
            Answer source,
            AnswerDto destination,
            LocationDataDto? destMember,
            ResolutionContext context)
        {
            // Only parse for Location question type
            if (source.Question?.QuestionType != QuestionType.Location)
                return null;

            if (string.IsNullOrWhiteSpace(source.AnswerJson))
                return null;

            try
            {
                // Use value object for parsing (includes validation)
                var locationValue = LocationAnswerValue.FromJson(source.AnswerJson);

                return new LocationDataDto
                {
                    Latitude = locationValue.Latitude,
                    Longitude = locationValue.Longitude,
                    Accuracy = locationValue.Accuracy,
                    Timestamp = locationValue.Timestamp
                };
            }
            catch (InvalidAnswerFormatException ex)
            {
                _logger?.LogWarning(ex,
                    "Invalid location data for answer {AnswerId}",
                    source.Id);
                return null;
            }
            catch (JsonException ex)
            {
                _logger?.LogWarning(ex,
                    "Failed to parse LocationData JSON for answer {AnswerId}",
                    source.Id);
                return null;
            }
        }
    }

- task_id: API-002
  title: "Add Location validation to ResponsesController"
  layer: "API"
  assigned_to: "aspnet-api-agent"
  priority: "High"
  estimated_hours: 1.5
  dependencies: ["CORE-002", "API-001"]
  parallel_safe: false
  status: "pending"
  description: |
    Add validation for Location answer submissions in ResponsesController.
    Ensures API clients provide valid location data.

  files:
    - path: "src/SurveyBot.API/Controllers/ResponsesController.cs"
      action: "modify"
      note: "Add validation for Location answer submissions"

  acceptance_criteria:
    - "Validates location answer data in SaveAnswer endpoint"
    - "Returns 400 Bad Request for invalid coordinates"
    - "Returns clear error messages indicating validation failure reason"
    - "Validation handled by ResponseService (controller delegates)"

  technical_notes: |
    Validation is primarily handled by ResponseService.ValidateAnswerFormatAsync,
    but controller should handle InvalidLocationException and return appropriate
    HTTP status codes.

    Error handling:
    catch (InvalidLocationException ex)
    {
        return BadRequest(new
        {
            error = "Invalid location data",
            details = ex.Message,
            latitude = ex.Latitude,
            longitude = ex.Longitude
        });
    }

- task_id: API-003
  title: "Update API layer CLAUDE.md documentation"
  layer: "API"
  assigned_to: "aspnet-api-agent"
  priority: "Medium"
  estimated_hours: 1
  dependencies: ["API-001", "API-002"]
  parallel_safe: false
  status: "pending"
  description: |
    Update API layer documentation for Location question support.

  files:
    - path: "src/SurveyBot.API/CLAUDE.md"
      action: "modify"
      note: "Document Location answer API support"

  acceptance_criteria:
    - "AnswerLocationDataResolver documented in AutoMapper section"
    - "Location validation documented in Controllers section"
    - "Location answer API request/response examples added"
    - "Version updated to 1.5.0"

  technical_notes: |
    Document:
    1. AnswerLocationDataResolver in AutoMapper section
    2. Location answer submission format
    3. Validation error responses
    4. Example API request/response for Location answers

# ==============================================================================
# PHASE 5: FRONTEND (REACT ADMIN PANEL)
# ==============================================================================

- task_id: FRONTEND-001
  title: "Add Location to question type selector"
  layer: "Frontend"
  assigned_to: "frontend-agent"
  priority: "High"
  estimated_hours: 1.5
  dependencies: ["CORE-001"]
  parallel_safe: true
  status: "pending"
  description: |
    Add Location option to question type selector/dropdown in admin panel.

  files:
    - path: "frontend/src/components/Questions/QuestionTypeSelector.tsx"
      action: "modify"
      note: "Add Location to question type options"
    - path: "frontend/src/types/QuestionType.ts"
      action: "modify"
      note: "Add Location = 4 to enum"

  acceptance_criteria:
    - "Location = 4 added to QuestionType enum"
    - "Location option appears in question type dropdown"
    - "Icon displayed: üìç"
    - "Label: 'Location'"
    - "Can select Location when creating questions"

  technical_notes: |
    Update QuestionType enum:
    export enum QuestionType {
      Text = 0,
      SingleChoice = 1,
      MultipleChoice = 2,
      Rating = 3,
      Location = 4,
    }

    Add to questionTypeOptions:
    { value: QuestionType.Location, label: 'Location', icon: 'üìç' }

- task_id: FRONTEND-002
  title: "Create LocationAnswerDisplay component"
  layer: "Frontend"
  assigned_to: "frontend-agent"
  priority: "High"
  estimated_hours: 2.5
  dependencies: ["CORE-002"]
  parallel_safe: false
  status: "pending"
  description: |
    Create React component to display location answer data in response viewer.
    Shows coordinates as text with optional accuracy and timestamp.

  files:
    - path: "frontend/src/components/Answers/LocationAnswerDisplay.tsx"
      action: "create"
      note: "New component for displaying location answers"

  acceptance_criteria:
    - "Displays latitude and longitude as formatted text"
    - "Shows accuracy if available (in meters)"
    - "Shows timestamp if available"
    - "Provides Google Maps link with coordinates"
    - "Material-UI styling consistent with other answer displays"
    - "Handles null/undefined data gracefully"

  technical_notes: |
    Component structure:

    interface LocationAnswerDisplayProps {
      locationData: LocationAnswerDto;
    }

    Display format:
    - Coordinates: 40.712776, -74.005974
    - Latitude: 40.712776¬∞
    - Longitude: -74.005974¬∞
    - Accuracy: ¬±65 meters (if available)
    - Captured: 11/26/2025, 10:30:00 AM (if available)
    - [View on Google Maps] link

    Google Maps URL:
    const googleMapsUrl =
      `https://www.google.com/maps?q=${latitude},${longitude}`;

    Use Typography, Box, Link from Material-UI for consistent styling.

- task_id: FRONTEND-003
  title: "Integrate LocationAnswerDisplay in response viewer"
  layer: "Frontend"
  assigned_to: "frontend-agent"
  priority: "High"
  estimated_hours: 1
  dependencies: ["FRONTEND-002"]
  parallel_safe: false
  status: "pending"
  description: |
    Integrate LocationAnswerDisplay component into response detail view.

  files:
    - path: "frontend/src/components/Responses/ResponseDetail.tsx"
      action: "modify"
      note: "Add Location answer rendering"

  acceptance_criteria:
    - "Location answers render using LocationAnswerDisplay component"
    - "Conditional rendering based on QuestionType.Location"
    - "Fallback message for missing/invalid location data"
    - "Consistent layout with other question types"

  technical_notes: |
    Add to answer rendering logic:

    case QuestionType.Location:
      return answer.locationData ? (
        <LocationAnswerDisplay locationData={answer.locationData} />
      ) : (
        <Typography color="textSecondary">No location data</Typography>
      );

- task_id: FRONTEND-004
  title: "Update Frontend CLAUDE.md documentation"
  layer: "Frontend"
  assigned_to: "frontend-agent"
  priority: "Medium"
  estimated_hours: 1
  dependencies: ["FRONTEND-001", "FRONTEND-002", "FRONTEND-003"]
  parallel_safe: false
  status: "pending"
  description: |
    Update frontend documentation for Location question support.

  files:
    - path: "frontend/CLAUDE.md"
      action: "modify"
      note: "Document Location question UI components"

  acceptance_criteria:
    - "LocationAnswerDisplay component documented"
    - "Question type selector update documented"
    - "Location answer display format documented"
    - "Version updated to 1.5.0"

  technical_notes: |
    Document:
    1. LocationAnswerDisplay component API
    2. Question type selector Location option
    3. Response viewer integration
    4. Google Maps link functionality

# ==============================================================================
# PHASE 6: TESTING
# ==============================================================================

- task_id: TEST-001
  title: "Unit tests for LocationQuestionHandler"
  layer: "Testing"
  assigned_to: "dotnet-testing-agent"
  priority: "High"
  estimated_hours: 3.5
  dependencies: ["BOT-001"]
  parallel_safe: false
  status: "pending"
  description: |
    Write comprehensive unit tests for LocationQuestionHandler.

  files:
    - path: "tests/SurveyBot.Tests/Handlers/LocationQuestionHandlerTests.cs"
      action: "create"
      note: "New test class"

  acceptance_criteria:
    - "Test coverage >= 80%"
    - "All test cases listed below implemented"
    - "Tests use proper mocking for dependencies"
    - "Tests use xUnit framework"
    - "Tests follow AAA pattern (Arrange, Act, Assert)"

  technical_notes: |
    Test cases to implement:

    [Fact] CanHandle_LocationQuestion_ReturnsTrue()
    [Fact] CanHandle_NonLocationQuestion_ReturnsFalse()
    [Fact] HandleAsync_ValidLocation_SavesAnswer()
    [Fact] HandleAsync_InvalidLatitude_ThrowsException()
      - Test: lat = -91.0, lat = 91.0
    [Fact] HandleAsync_InvalidLongitude_ThrowsException()
      - Test: lon = -181.0, lon = 181.0
    [Fact] HandleAsync_SkipOptionalQuestion_Succeeds()
    [Fact] HandleAsync_SkipRequiredQuestion_ShowsError()
    [Fact] HandleAsync_TextInsteadOfLocation_ShowsError()
    [Fact] HandleAsync_LocationOutOfBounds_ThrowsException()
    [Fact] HandleAsync_LocationWithAccuracy_SavesAllData()
    [Fact] HandleAsync_RemovesKeyboardAfterSubmission()

    [Theory]
    [InlineData(-90.0, -180.0)]   // Min valid
    [InlineData(90.0, 180.0)]     // Max valid
    [InlineData(0.0, 0.0)]        // Origin
    [InlineData(40.712776, -74.005974)]  // NYC
    HandleAsync_ValidCoordinates_Succeeds(double lat, double lon)

    Mock dependencies:
    - IResponseService
    - ITelegramBotClient
    - ILogger<LocationQuestionHandler>

- task_id: TEST-002
  title: "Unit tests for Location validation in ResponseService"
  layer: "Testing"
  assigned_to: "dotnet-testing-agent"
  priority: "High"
  estimated_hours: 2.5
  dependencies: ["INFRA-001"]
  parallel_safe: false
  status: "pending"
  description: |
    Write unit tests for Location answer validation in ResponseService.

  files:
    - path: "tests/SurveyBot.Tests/Services/ResponseServiceLocationTests.cs"
      action: "create"
      note: "New test class"

  acceptance_criteria:
    - "Test coverage >= 80%"
    - "All test cases listed below implemented"
    - "Tests use in-memory database or proper mocking"
    - "Tests verify exception types and messages"

  technical_notes: |
    Test cases to implement:

    [Fact] SaveAnswerAsync_ValidLocation_Succeeds()
    [Fact] SaveAnswerAsync_InvalidLatitude_ThrowsInvalidLocationException()
    [Fact] SaveAnswerAsync_InvalidLongitude_ThrowsInvalidLocationException()
    [Fact] SaveAnswerAsync_MissingAnswerJson_ThrowsValidationException()
    [Fact] SaveAnswerAsync_InvalidJson_ThrowsValidationException()
    [Fact] ValidateLocationData_ValidCoordinates_NoException()
    [Fact] ValidateLocationData_NullData_ThrowsException()

    [Theory]
    [InlineData(-91.0, 0.0)]      // Latitude too low
    [InlineData(91.0, 0.0)]       // Latitude too high
    [InlineData(0.0, -181.0)]     // Longitude too low
    [InlineData(0.0, 181.0)]      // Longitude too high
    SaveAnswerAsync_CoordinatesOutOfBounds_ThrowsException(double lat, double lon)

    [Theory]
    [InlineData(-90.0, -180.0)]   // Min valid
    [InlineData(90.0, 180.0)]     // Max valid
    [InlineData(0.0, 0.0)]        // Origin
    SaveAnswerAsync_ValidBoundaryCoordinates_Succeeds(double lat, double lon)

- task_id: TEST-003
  title: "Integration tests for Location answer API"
  layer: "Testing"
  assigned_to: "dotnet-testing-agent"
  priority: "High"
  estimated_hours: 2.5
  dependencies: ["API-001", "API-002"]
  parallel_safe: false
  status: "pending"
  description: |
    Write integration tests for Location answer API endpoints.

  files:
    - path: "tests/SurveyBot.Tests/Controllers/ResponsesControllerLocationTests.cs"
      action: "create"
      note: "New test class"

  acceptance_criteria:
    - "Tests use WebApplicationFactory for integration testing"
    - "Tests verify HTTP status codes and response bodies"
    - "Tests verify database state changes"
    - "All test cases listed below implemented"

  technical_notes: |
    Test cases to implement:

    [Fact] SaveAnswer_ValidLocationAnswer_Returns201()
      - Verify Answer.AnswerJson contains location data
      - Verify response includes created answer ID

    [Fact] SaveAnswer_InvalidLocationCoordinates_Returns400()
      - Test with lat = 100.0 (out of bounds)
      - Verify error message describes coordinate issue

    [Fact] SaveAnswer_MissingLocationData_Returns400()
      - Test with empty answerJson
      - Verify error message indicates missing data

    [Fact] GetResponseWithLocationAnswers_ReturnsLocationData()
      - Create response with Location answer
      - GET response detail
      - Verify LocationData property populated in AnswerDto
      - Verify latitude, longitude, accuracy, timestamp present

    [Fact] SaveAnswer_LocationWithAccuracy_StoresAllFields()
      - Submit location with accuracy and timestamp
      - Verify all fields stored in database

    Use TestContext and seed data for consistent test environment.

- task_id: TEST-004
  title: "Manual testing checklist and execution"
  layer: "Testing"
  assigned_to: "dotnet-testing-agent"
  priority: "Medium"
  estimated_hours: 1.5
  dependencies: ["BOT-001", "API-001", "FRONTEND-002"]
  parallel_safe: false
  status: "pending"
  description: |
    Create manual testing checklist and execute tests on development environment.
    Document results and any bugs discovered.

  files:
    - path: "documentation/testing/LOCATION_QUESTION_MANUAL_TESTING.md"
      action: "create"
      note: "Manual testing checklist and results"

  acceptance_criteria:
    - "Manual testing checklist document created"
    - "All test scenarios listed below executed"
    - "Results documented with pass/fail status"
    - "Screenshots captured for key scenarios"
    - "Bugs reported with reproduction steps"

  technical_notes: |
    Manual Testing Checklist:

    Survey Creation:
    [ ] Create survey with Location question via bot
    [ ] Create survey with Location question via API
    [ ] Create optional Location question
    [ ] Create required Location question
    [ ] Verify Location appears in question type dropdown (frontend)

    Bot Testing - Mobile (iOS and Android):
    [ ] "Share Location" button displays correctly
    [ ] Button uses emoji: üìç
    [ ] Keyboard is custom (ReplyKeyboardMarkup)
    [ ] Tap button opens location permission dialog
    [ ] Grant permission and share location
    [ ] Location sent successfully (no errors)
    [ ] Confirmation message shows coordinates
    [ ] Keyboard removed after submission
    [ ] Next question displays correctly

    Bot Testing - Desktop (Telegram Web/Desktop):
    [ ] "Share Location" button displays
    [ ] Click button opens map picker
    [ ] Can select location on map
    [ ] Manual selection works
    [ ] Location saved successfully

    Bot Testing - Validation:
    [ ] Send text message instead of location
    [ ] Error message displayed: "Please share location using button"
    [ ] /skip command works for optional questions
    [ ] /skip shows error for required questions

    API Testing (use Swagger or Postman):
    [ ] POST location answer with valid coordinates returns 201
    [ ] POST with lat = 100.0 returns 400 (out of bounds)
    [ ] POST with lon = 200.0 returns 400 (out of bounds)
    [ ] POST with missing answerJson returns 400
    [ ] GET response includes LocationData in answer
    [ ] LocationData has latitude, longitude, accuracy, timestamp

    Frontend Testing:
    [ ] Create Location question in admin panel
    [ ] Location option appears in type selector
    [ ] View survey response with location answer
    [ ] Coordinates display as text
    [ ] Accuracy displayed if present
    [ ] Timestamp displayed if present
    [ ] Google Maps link works (opens correct location)
    [ ] Layout consistent with other answer types

    Edge Cases:
    [ ] Location at North Pole (90.0, 0.0)
    [ ] Location at South Pole (-90.0, 0.0)
    [ ] Location at date line (0.0, 180.0)
    [ ] Location with high accuracy (< 10 meters)
    [ ] Location with low accuracy (> 1000 meters)
    [ ] Location without accuracy field
    [ ] Location without timestamp field

    Performance:
    [ ] Response time < 2 seconds for location save
    [ ] Multiple location answers in same response
    [ ] Survey with 10+ Location questions

# ==============================================================================
# PHASE 7: DOCUMENTATION
# ==============================================================================

- task_id: DOCS-001
  title: "Update Core layer CLAUDE.md for Location support"
  layer: "Documentation"
  assigned_to: "ef-core-agent"
  priority: "Medium"
  estimated_hours: 1
  dependencies: ["CORE-001", "CORE-002", "CORE-003", "CORE-004"]
  parallel_safe: true
  status: "pending"
  description: |
    Update Core layer documentation to reflect Location question type additions.

  files:
    - path: "src/SurveyBot.Core/CLAUDE.md"
      action: "modify"
      note: "Document Location enum, DTOs, and exception"

  acceptance_criteria:
    - "Location added to QuestionType enum documentation"
    - "LocationAnswerDto documented with properties and validation rules"
    - "AnswerDto LocationData property documented"
    - "InvalidLocationException documented"
    - "Version updated to 1.5.0"
    - "Recent Changes section updated"

  technical_notes: |
    Document:
    1. QuestionType.Location = 4 enum value
    2. LocationAnswerDto structure and validation rules
    3. AnswerDto.LocationData property
    4. InvalidLocationException usage
    5. JSON storage format in AnswerJson

- task_id: DOCS-002
  title: "Create feature documentation for Location questions"
  layer: "Documentation"
  assigned_to: "project-manager-agent"
  priority: "High"
  estimated_hours: 2.5
  dependencies:
    - "CORE-001"
    - "CORE-002"
    - "BOT-001"
    - "INFRA-001"
    - "API-001"
    - "FRONTEND-002"
  parallel_safe: false
  status: "pending"
  description: |
    Create comprehensive feature documentation for Location questions.
    Includes user guide, technical implementation, API reference, troubleshooting.

  files:
    - path: "documentation/features/LOCATION_QUESTIONS.md"
      action: "create"
      note: "New feature documentation"

  acceptance_criteria:
    - "Feature overview section written"
    - "User guide for bot users included"
    - "User guide for admin panel users included"
    - "Technical implementation details documented"
    - "API reference for Location answers included"
    - "Troubleshooting section added"
    - "Code examples provided for all layers"

  technical_notes: |
    Document structure:

    1. Feature Overview
       - What is Location question type
       - Use cases
       - Supported platforms

    2. User Guide - Telegram Bot
       - How to answer Location questions
       - Mobile instructions
       - Desktop instructions
       - Skipping optional questions

    3. User Guide - Admin Panel
       - Creating Location questions
       - Viewing location responses
       - Exporting data

    4. Technical Implementation
       - Data storage format (JSON)
       - Validation rules
       - Architecture overview (layer-by-layer)

    5. API Reference
       - Request format
       - Response format
       - Error codes
       - Examples

    6. Troubleshooting
       - Location not saving
       - Permission denied
       - Invalid coordinates error
       - Button not showing

    Include code snippets for:
    - JSON format
    - API request/response
    - Handler implementation

- task_id: DOCS-003
  title: "Update documentation index"
  layer: "Documentation"
  assigned_to: "project-manager-agent"
  priority: "Medium"
  estimated_hours: 0.5
  dependencies: ["DOCS-002"]
  parallel_safe: false
  status: "pending"
  description: |
    Update documentation index to include Location question documentation.

  files:
    - path: "documentation/INDEX.md"
      action: "modify"
      note: "Add Location question docs to features section"

  acceptance_criteria:
    - "Location question feature added to features section"
    - "Link to LOCATION_QUESTIONS.md included"
    - "Description added"
    - "Index remains alphabetically organized"

  technical_notes: |
    Add to features section:
    - **[Location Questions](features/LOCATION_QUESTIONS.md)** -
      Geographic location question type with Telegram location sharing

- task_id: DOCS-004
  title: "Update main CLAUDE.md for v1.5.0"
  layer: "Documentation"
  assigned_to: "project-manager-agent"
  priority: "High"
  estimated_hours: 1
  dependencies:
    - "DOCS-001"
    - "DOCS-002"
    - "DOCS-003"
  parallel_safe: false
  status: "pending"
  description: |
    Update main project CLAUDE.md to reflect v1.5.0 changes.

  files:
    - path: "C:/Users/User/Desktop/SurveyBot/CLAUDE.md"
      action: "modify"
      note: "Update version, features, entity diagram, recent changes"

  acceptance_criteria:
    - "Version updated to 1.5.0 throughout document"
    - "Location added to question types list"
    - "Entity relationship diagram updated to show Location"
    - "Recent Changes section updated with v1.5.0 entry"
    - "Quick reference includes Location type"
    - "Feature list includes Location questions"

  technical_notes: |
    Update sections:

    1. Version (line 3): Update to 1.5.0

    2. Key Features section: Add
       "Location Questions - Request coordinates via Telegram location sharing"

    3. Question Types section: Add
       "Location - Geographic coordinates (latitude/longitude)"

    4. Entity Relationship Overview: Update description to mention
       Location question type

    5. Recent Changes: Add v1.5.0 entry
       **v1.5.0 (Location Question Type)**:
       - Added Location to QuestionType enum (value = 4)
       - Created LocationAnswerDto for coordinate data
       - Implemented LocationQuestionHandler with ReplyKeyboardMarkup
       - Added coordinate validation across all layers
       - Updated AutoMapper for Location data mapping
       - Added frontend LocationAnswerDisplay component
       - No database migration required (uses existing AnswerJson)

    6. Summary for AI Assistants: Add Location to question types list

# ==============================================================================
# PARALLEL WORK OPPORTUNITIES
# ==============================================================================

parallel_groups:
  - name: "Core DTOs and Exceptions"
    can_run_parallel: true
    tasks: ["CORE-002", "CORE-004"]
    note: "These tasks have no dependencies between them"

  - name: "Frontend Components"
    can_run_parallel: true
    tasks: ["FRONTEND-001"]
    note: "Can start once CORE-001 is complete"

  - name: "Documentation"
    can_run_parallel: true
    tasks: ["DOCS-001"]
    note: "Can start once respective implementation tasks complete"

# ==============================================================================
# CRITICAL PATH (MUST BE SEQUENTIAL)
# ==============================================================================

critical_path:
  - task: "DATABASE-001"
    reason: "BLOCKER - Database constraint must allow value 4"
  - task: "CORE-001"
    reason: "Foundation - All layers depend on enum"
  - task: "CORE-002"
    reason: "Data structure - Bot and API need DTO"
  - task: "BOT-001"
    reason: "Core feature - Location input mechanism"
  - task: "BOT-002"
    reason: "Message routing - Without this, location messages are dropped"
  - task: "INFRA-001"
    reason: "Validation - Without this, invalid data can be saved"
  - task: "API-001"
    reason: "Data mapping - Without this, API won't return location data"
  - task: "FRONTEND-002"
    reason: "Display - Users need to see location data"
  - task: "Testing"
    reason: "Quality assurance - Verify all functionality works"
  - task: "Documentation"
    reason: "Knowledge transfer - Document completed feature"

# ==============================================================================
# RISK MITIGATION
# ==============================================================================

risks:
  - risk_id: "RISK-001"
    description: "Database CHECK constraint blocks Location questions"
    severity: "Critical"
    probability: "High"
    mitigation: "DATABASE-001 must be completed first (BLOCKER task)"
    status: "Mitigated by task ordering"

  - risk_id: "RISK-002"
    description: "Location messages silently dropped by UpdateHandler"
    severity: "Critical"
    probability: "High"
    mitigation: "BOT-002 fixes message routing to check Location before text"
    status: "Identified in codebase analysis, fix planned"

  - risk_id: "RISK-003"
    description: "Location validation bypassed in ResponseService"
    severity: "High"
    probability: "High"
    mitigation: "INFRA-001 adds Location case to ValidateAnswerFormatAsync"
    status: "Identified in codebase analysis, fix planned"

  - risk_id: "RISK-004"
    description: "Location data lost in CreateAnswerJson"
    severity: "High"
    probability: "High"
    mitigation: "INFRA-001 adds Location case to CreateAnswerJson (pass-through)"
    status: "Identified in codebase analysis, fix planned"

  - risk_id: "RISK-005"
    description: "API responses missing LocationData"
    severity: "High"
    probability: "High"
    mitigation: "API-001 creates AnswerLocationDataResolver for AutoMapper"
    status: "Identified in codebase analysis, fix planned"

  - risk_id: "RISK-006"
    description: "Wrong keyboard type used (Inline instead of Reply)"
    severity: "Medium"
    probability: "Medium"
    mitigation: "BOT-001 specification explicitly requires ReplyKeyboardMarkup"
    status: "Documented in task requirements and technical notes"

  - risk_id: "RISK-007"
    description: "User permission denial for location sharing"
    severity: "Low"
    probability: "Medium"
    mitigation: "/skip support for optional questions, clear error messages"
    status: "Handled by BOT-001 implementation"

# ==============================================================================
# EXECUTION TIMELINE (ESTIMATED)
# ==============================================================================

timeline:
  week_1:
    day_1:
      tasks: ["DATABASE-001", "CORE-001", "CORE-002", "CORE-004"]
      estimated_hours: 6-8
      notes: "Start with BLOCKER, then Core foundation"

    day_2:
      tasks: ["BOT-001", "BOT-002", "BOT-003"]
      estimated_hours: 7-9
      notes: "Bot layer implementation and message routing"

    day_3:
      tasks: ["INFRA-001", "INFRA-002", "API-001"]
      estimated_hours: 6-8
      notes: "Validation and API mapping"

    day_4:
      tasks: ["API-002", "FRONTEND-001", "FRONTEND-002", "FRONTEND-003"]
      estimated_hours: 6-8
      notes: "API finalization and frontend components"

    day_5:
      tasks: ["BOT-004", "CORE-003", "Integration testing"]
      estimated_hours: 4-6
      notes: "Polish and integration, bug fixes"

  week_2:
    day_1:
      tasks: ["TEST-001", "TEST-002"]
      estimated_hours: 6-8
      notes: "Unit tests for bot and infrastructure"

    day_2:
      tasks: ["TEST-003", "TEST-004"]
      estimated_hours: 4-6
      notes: "Integration and manual testing"

    day_3:
      tasks: ["DOCS-001", "DOCS-002", "DOCS-003", "DOCS-004"]
      estimated_hours: 5-6
      notes: "Documentation across all layers"

    day_4:
      tasks: ["BOT-005", "INFRA-003", "API-003", "FRONTEND-004"]
      estimated_hours: 5-6
      notes: "Layer-specific documentation updates"

    day_5:
      tasks: ["Final QA", "Bug fixes", "Release preparation"]
      estimated_hours: 4-6
      notes: "Final testing, fix critical bugs, prepare release"

# ==============================================================================
# SUCCESS CRITERIA
# ==============================================================================

success_criteria:
  functional:
    - "Location added to QuestionType enum with value 4"
    - "Share Location button displays in Telegram (ReplyKeyboardMarkup)"
    - "Location data saved to Answer.AnswerJson as JSON"
    - "Coordinate validation working: lat -90 to 90, lon -180 to 180"
    - "/skip command works for optional Location questions"
    - "Frontend displays coordinates as text with Google Maps link"
    - "API responses include LocationData for Location answers"

  technical:
    - "Core layer maintains zero dependencies"
    - "No database migration required (uses existing AnswerJson column)"
    - "Unit test coverage >= 80% for Location functionality"
    - "All integration tests passing"
    - "Manual testing checklist 100% complete"
    - "No regression in existing question types"

  documentation:
    - "All layer CLAUDE.md files updated to v1.5.0"
    - "Feature documentation created (LOCATION_QUESTIONS.md)"
    - "Documentation index updated"
    - "Main CLAUDE.md updated with v1.5.0 changes"
    - "Code examples provided for all layers"

  non_functional:
    - "Response time < 2 seconds for location save"
    - "Mobile platform support: iOS and Android"
    - "Desktop platform support: manual map selection"
    - "Graceful error handling for permission denial"
    - "Privacy-preserving logging (coordinate ranges, not exact values)"

# ==============================================================================
# NOTES FOR SPECIALIST AGENTS
# ==============================================================================

agent_notes:
  ef-core-agent:
    - "Start with DATABASE-001 (BLOCKER) - this is critical"
    - "Core layer tasks (CORE-001 through CORE-004) must maintain zero dependencies"
    - "LocationAnswerDto validation rules are essential for multi-layer validation"
    - "INFRA-001 has critical bug fixes - read technical notes carefully"

  telegram-bot-handler-agent:
    - "BOT-001: MUST use ReplyKeyboardMarkup - InlineKeyboardMarkup will NOT work"
    - "BOT-002: Critical fix - current code drops Location messages"
    - "Serialize location to JSON before calling SaveAnswerAsync"
    - "Remove keyboard with ReplyKeyboardRemove after location submission"
    - "Implement privacy-preserving logging with GetCoordinateRange()"

  aspnet-api-agent:
    - "API-001: AnswerLocationDataResolver is critical - API won't return location without it"
    - "Graceful error handling for invalid JSON in resolver"
    - "Validation primarily handled by ResponseService, controller delegates"

  dotnet-testing-agent:
    - "Focus on boundary value testing for coordinates"
    - "Test both valid boundaries and out-of-bounds values"
    - "Manual testing checklist is comprehensive - execute thoroughly"
    - "Document all bugs found with reproduction steps"

  frontend-agent:
    - "LocationAnswerDisplay should match styling of other answer components"
    - "Google Maps link format: https://www.google.com/maps?q=LAT,LON"
    - "Handle null/undefined gracefully - not all fields are required"

  project-manager-agent:
    - "Ensure DATABASE-001 is completed before any other tasks"
    - "Monitor critical path tasks closely"
    - "DOCS-002 should be comprehensive - it's the primary user-facing documentation"
    - "Coordinate with all specialists for accurate documentation"
